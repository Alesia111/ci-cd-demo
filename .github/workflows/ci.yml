name: L2EVPN CI/CD Demo

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

concurrency:
  group: l2evpn-ci
  cancel-in-progress: true

jobs:
  precheck:
    name: 1) Precheck YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install pyyaml
      - run: mkdir -p logs
      - name: Run precheck
        run: python scripts/precheck_yaml.py | tee -a logs/pipeline.log
      - name: Write CSV header
        run: echo "Run,Duration_s,Timestamp" > logs/test_summary.csv

  build:
    name: 2) Build Lab (mock)
    runs-on: ubuntu-latest
    needs: precheck
    steps:
      - uses: actions/checkout@v4
      - name: Mock build
        run: |
          echo "Starting build..." | tee -a logs/pipeline.log
          sleep 3
          echo "âœ… Build completed (mock) @ $(date -Iseconds)" | tee -a logs/pipeline.log
      - name: CSV row run 1
        run: echo "1,15,$(date -Iseconds)" >> logs/test_summary.csv
      - uses: actions/upload-artifact@v4
        with: { name: l2evpn-logs, path: logs/*, if-no-files-found: warn }

  config:
    name: 3) Push Config (mock)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Run config
        run: python scripts/push_config.py | tee -a logs/pipeline.log
      - name: CSV row run 2
        run: echo "2,0,$(date -Iseconds)" >> logs/test_summary.csv
      - uses: actions/upload-artifact@v4
        with: { name: l2evpn-logs, path: logs/*, if-no-files-found: warn }

  validate:
    name: 4) Validation (mock)
    runs-on: ubuntu-latest
    needs: config
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        run: python scripts/run_tests.py | tee -a logs/pipeline.log
      - name: CSV row run 3
        run: echo "3,0,$(date -Iseconds)" >> logs/test_summary.csv
      - name: Upload final artifacts
        uses: actions/upload-artifact@v4
        with:
          name: l2evpn-logs
          path: logs/*
          if-no-files-found: error
